---
title: '''Phase 1: Agricultural Commodity Loss Variations across the Pacific Northwest'
author: "Erich Seamon"
date: "8/25/2018"
output:
  html_document: default
  pdf_document: default
params:
  output_dir: /dmine/code/git/dmine-paper1/
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Introduction

This analysis explores the relationships of agricultural commodity loss, at a county level, from 1989-2015, for the 26 county region of the Palouse, in Washington, Idaho, and Oregon. Here we explore the entire range of commodities and damage causes, identifying the top revenue loss commodities and their most pertinent damage causes - as indicated from the USDA's agricultural commodity loss insurance archive.

We perform several steps to examine the full set of data, and to narrow down factors to a usable form, for mixed modeling analysis.
<br></br>
<br></br>
**Step 1.** Data Preparation: Loading and Transforming data.  Here we load commodity loss data, and aggregate by differing factors, so we can examine losses on an annual basis, by county, damage cause, and commodity.
<br></br>
<br></br>
**Step 2.** Study Area Overview.  We narrow down our data to the 26 county palouse region, and display a study area map for perspective.
<br></br>
<br></br>
**Step 3.** Summary Overview of total revenue by Commodity.  We summarize all commodity insurance loss by commodity - so we can determine the top revenue loss commodities for a filtered examination.
<br></br>
<br></br>
**Step 4.** Summary Overview of total revenue by Damage Cause.  Similarly to Step 3, we summarize all insurance loss by the cause of the damage, so we can determine which damage causes are resulting the the majority of insurance loss.
<br></br>
<br></br>
**Step 5.** Refinement of data to top revenue commodities, and Damage Causes that are most impactful.  Given Steps 3 and 4, here we narrow down our dataset to only examine those top commodities and most impactful damage causes.
<br></br>
<br></br>
**Step 6.** Exploratory Analysis of top commodities individually, to see variations by damage cause.  In Step 6, we now examine the top commodities individually, looking at how insurance loss varies by damage cause, by county, and by year.
<br></br>
<br></br>

##Step 1. Data Preparation: Loading and Transformation data

The first step is to load Pacific Northwest agricultural insurance commodity loss data, aggregate by county, damage cause and commodity, remove zeros, transform the loss values ($) into cube root and logrithmic outputs, and scale and center the data.  

```{r message=FALSE, warning=FALSE, echo=FALSE}

library(car)
library(RCurl)
library(lme4)
library(ez)
library(lattice)
library(ggplot2)
library(coefplot2)
library(broom)

#options(scipen=999)

#-load data
Southern_ID_sumloss <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/dmine_anova/master/PNW_summary_all.csv"), 
header = TRUE)
Southern_ID_sumloss_all_sum  <- aggregate(loss ~ year + 
                                            damagecause + county + commodity,  
                                          Southern_ID_sumloss, sum)
Southern_ID_count_all_count  <- aggregate(count ~ year + 
                                            damagecause + county + commodity,  
                                          Southern_ID_sumloss, sum)
Southern_ID_sumloss_all_sum <- 
  Southern_ID_sumloss_all_sum[Southern_ID_sumloss_all_sum$loss >= 1, ]

#-Loading all WHEAT claims for the palouse from 1989-2015
palouse_sumloss <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/dmine_anova/master/Palouse_summary_sumloss.csv"), 
header = TRUE)
palouse_counts <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/dmine_anova/master/Palouse_summary_counts.csv"), 
header = TRUE)

#use a cube transformation on loss for WHEAT claims
Math.cbrt <- function(x) {
  sign(x) * abs(x)^(1/3)
}

Southern_ID_sumloss_all_sum$cube_loss <- Math.cbrt(Southern_ID_sumloss_all_sum$loss)
Southern_ID_count_all_count$cube_counts <- Math.cbrt(Southern_ID_count_all_count$count)

#--aggregate palouse
palouse_sumloss_aggregate <- aggregate(loss ~ damagecause + year + commodity + county, 
                                       palouse_sumloss, mean)

#-calculate cube loss
palouse_sumloss_aggregate$cube_loss <- Math.cbrt(palouse_sumloss_aggregate$loss)

#-remove zeros
palouse_sumloss_aggregate <- subset(palouse_sumloss_aggregate, loss > 0)

#-use a log transform 

palouse_sumloss_aggregate$log10_loss <- log10(palouse_sumloss_aggregate$loss)
palouse_sumloss_aggregate$log_loss <- log(palouse_sumloss_aggregate$loss)

#-inverse transform
palouse_sumloss_aggregate$inverse_loss <- 1/palouse_sumloss_aggregate$loss

#sq root transformation
palouse_sumloss_aggregate$sqroot_loss <- sqrt(palouse_sumloss_aggregate$loss)

#--scale and center
palouse_sumloss_aggregate$scaled_cube_loss <- scale(palouse_sumloss_aggregate$cube_loss)
palouse_sumloss_aggregate$scaled_inverse_loss <- 
  scale(palouse_sumloss_aggregate$inverse_loss, center = TRUE, scale = TRUE)

```
<br></br>

##Step 2: Study Area Overview - 26 County Palouse Region


```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(data.table)
library(maptools)
library(classInt)
library(leaflet)
library(dplyr)
library(raster)
#--irrigation analysis 2018


setwd("/dmine/data/counties/")

counties <- readShapePoly('/dmine/data/counties/threestate_palouse.shp',
                     proj4string=CRS
                     ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

#pal <- colorNumeric(palette = c("white", "orange", "darkorange", "red", "darkred"),
#                    domain = counties$NAME)
exte <- as.vector(extent(counties))

#label <- paste(sep = "<br/>", counties$NAME, round(counties$NAME, 0))
#markers <- data.frame(label)
#labs <- as.list(counties$NAME)

leaflet(data = counties, options = leafletOptions(minZoom = 6, maxZoom = 6)) %>%  addProviderTiles("Stamen.TonerLite") %>% fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(color = "red",  weight = 1)

 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")


```
<center>
**FIGURE 1:** 26 county Palouse region study area.
</center>

<br></br>


##Step 3: Summary Overview of Insurance Loss by Commodity: 1989 - 2015 for the Palouse

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}


palouse_sumloss_1989_2015 <- aggregate(palouse_sumloss_aggregate$loss, list(palouse_sumloss_aggregate$commodity), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("commodity", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
XX <- subset(X, loss > 10000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

YYY1<- YYY1[seq(dim(YYY1)[1],1),]
grid.table(YYY1, theme = tt3)


par(mar=c(10.8, 7.1, 2.1, 2.1), mgp=c(6, 1, 0), las=0)
levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$commodity, las = 3, yaxt="n", ylab = "Loss ($)", main = "Total Insurance Loss by Commodity: 1989 - 2015") 
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

```

**FIGURE 2:** Breakdown of total insurance loss by COMMODITY for the 26 county Palouse region, from 1989 - 2015. In order to reduce our dataset analysis, we are limiting our examination to only the cropping systems that incurred the most revenue loss - which are: 1. Wheat; 2. Apples; 3. Cherries; and 4. Dry Peas

<br></br>

##STEP 4: Total Revenue by Damage Cause, 1989 - 2015 for the Palouse

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}


palouse_sumloss_1989_2015 <- aggregate(palouse_sumloss_aggregate$loss, list(palouse_sumloss_aggregate$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("commodity", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
XX <- subset(X, loss > 10000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))


YYY1<- YYY1[seq(dim(YYY1)[1],1),]
grid.table(YYY1, theme = tt3)

par(mar=c(11.8, 6.1, 2.1, 2.1), mgp=c(4, 1, 0), las=0)
barplot(YYY1$loss, names.arg = YYY1$commodity, las = 3, yaxt="n", ylab = "Loss ($)", main = "Total Revenue by Damage Cause \n 1989 - 2015 for the Palouse")
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

```

**FIGURE 3:** Breakdown of total insurance loss by DAMAGE CAUSE for the 26 county Palouse region, from 1989 - 2015.  In order to reduce our dataset analysis, we are limiting our examination to only the DAMAGE CAUSES that are incurred by the combination of the FOUR main commodities: wheat, apples, cherries, and dry peas.

<br></br>

##STEP 5: Damage Cause Overview for EACH of the four top commodities

<br></br>

### Top Damage Causes for APPLES, 1989-2015 for the Palouse Region

<br></br>

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

#--reduce years to 2001-2015
xxyear <- subset(palouse_sumloss_aggregate, year >= 2001)

#missing data review of data from 2001-2015 for all commodities and all damage causes
#ezDesign(xxyear, year, damagecause)
#ezDesign(xxyear, county, damagecause)
#ezDesign(xxyear, county, commodity)

#Now lets subset by the four main commodities of interest.
#--subset to four commodities - Barley, Wheat, Apples, and Dry Peas
xx <- subset(xxyear, commodity == "BARLEY" | commodity == "WHEAT" | 
               commodity == "APPLES" | commodity == "DRY PEAS" | commodity == "CHERRIES")

#--subset to a select set of damage causes - Drought, Heat, Hail, Frost, Freeze, Excessive Moisture, Cold Winter, Cold Weather, and Decline in Price
xxx <- subset(xx, damagecause == "Drought" | damagecause == "Heat" | 
                damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze" | damagecause == "Excessive Moisture/Precip/Rain" | damagecause == "Cold Winter" | 
                damagecause == "Cold Wet Weather" | damagecause == "Decline in Price")


#examine missing data after narrowing commodities and damage causes to the most relevant
#ezDesign(xxx, year, damagecause)
#ezDesign(xxx, county, year)
#ezDesign(xxx, county, damagecause)
#ezDesign(xxx, year, commodity)
#ezDesign(xxx, county, commodity)

#palouse_sumloss_aggregate <- xxx

#now lets divide the data into four different model files that are commodity specific.
xxx_wheat <- subset(xxx, commodity == "WHEAT")
xxx_apples <- subset(xxx, commodity == "APPLES")
xxx_cherries <- subset(xxx, commodity == "CHERRIES")
xxx_drypeas <- subset(xxx, commodity == "DRY PEAS")

palouse_sumloss_aggregate_apples <- xxx_apples
palouse_sumloss_aggregate_cherries <- xxx_cherries
palouse_sumloss_aggregate_drypeas <- xxx_drypeas
palouse_sumloss_aggregate_wheat <- xxx_wheat

#-remove counties for each commodity file that have considerable missing data.  
#the reasoning is that those counties that have very little of the commodity in question
#may be inappropriate to fill in data as zero.  While there are sporadic commodity loss
#for these counties, there is a high liklihood that this commodity may NOT be grown
#for the missing years, vs just no commodity loss claims.  So we remove these select
#counties given the EzDesign data review of each commodity file

palouse_sumloss_aggregate_apples <- subset(palouse_sumloss_aggregate_apples, 
                                           county != "Columbia" & county != "Wasco")
palouse_sumloss_aggregate_apples$county <- 
  factor(palouse_sumloss_aggregate_apples$county)

palouse_sumloss_aggregate_wheat <- 
  subset(palouse_sumloss_aggregate_wheat, county != "Kootenai")
palouse_sumloss_aggregate_wheat$county <- 
  factor(palouse_sumloss_aggregate_wheat$county)

palouse_sumloss_aggregate_cherries <- 
  subset(palouse_sumloss_aggregate_cherries, county != "Adams" & county != "Union")
palouse_sumloss_aggregate_cherries$county <- 
  factor(palouse_sumloss_aggregate_cherries$county)

palouse_sumloss_aggregate_drypeas <- 
  subset(palouse_sumloss_aggregate_drypeas, county != "Douglas" 
         & county != "Gilliam" & county != "Adams")
palouse_sumloss_aggregate_drypeas$county <- 
  factor(palouse_sumloss_aggregate_drypeas$county)

#re-factor 

palouse_sumloss_aggregate_apples$damagecause <- factor(palouse_sumloss_aggregate_apples$damagecause)
palouse_sumloss_aggregate_wheat$damagecause <- factor(palouse_sumloss_aggregate_wheat$damagecause)
palouse_sumloss_aggregate_cherries$damagecause <- factor(palouse_sumloss_aggregate_cherries$damagecause)
palouse_sumloss_aggregate_drypeas$damagecause <- factor(palouse_sumloss_aggregate_drypeas$damagecause)

```



```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

APPLES <- subset(palouse_sumloss_aggregate, commodity == "APPLES")

palouse_sumloss_1989_2015 <- aggregate(APPLES$loss, list(APPLES$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 1500000) 
summary_dataset2 <- X %>% filter(loss > 1500000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' million'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for APPLES, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

           
p

par(mar=c(11.8, 6.1, 2.1, 2.1), mgp=c(4, 1, 0), las=0)
barplot(YYY$loss, names.arg = YYY$damagecause, las = 3, yaxt="n", ylab = "Loss ($)", main = "APPLES: Total Loss by Damage Cause \n 1989 - 2015")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

```


```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

#--interaction plot loss vs year for all damage causes, all Palouse counties

par(mar = c(5, 5, 4, 1))
apples <- palouse_sumloss_aggregate_apples
i <- interaction.plot(x.factor     = apples$year,
                 trace.factor = apples$damagecause, 
                 trace.label = "apples",
                 response     = apples$loss, 
                 fun = sum,
                 las = 3,
                 type="b",
                 col=c("black","red","green"),  ### Colors for levels of trace var.
                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
                 fixed=TRUE,                    ### Order by factor order in data
                 leg.bty = "n",
                 ylab="",
                 xlab="Year",
                 main="Interaction Plot - APPLES Loss vs. year - top damage causes", las = 2)

```

**FIGURE 4.** In the bar plot above, 1. Hail, 2. Frost, 3. Freeze, and 4. Cold Wet Weather are the predominant causes for loss for APPLES.
The interaction plot above also shows that hail damage causes are tending to be quite high in 2006, 2012, and 2015.


<br></br>

### Top Damage Causes for WHEAT, 1989-2015 for the Palouse Region
```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

WHEAT <- subset(palouse_sumloss_aggregate, commodity == "WHEAT")

palouse_sumloss_1989_2015 <- aggregate(WHEAT$loss, list(WHEAT$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 2000000) 
summary_dataset2 <- X %>% filter(loss > 2000000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' billions'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for WHEAT, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

  
p         

par(mar=c(11.8, 6.1, 2.1, 2.1), mgp=c(4, 1, 0), las=0)
barplot(YYY$loss, names.arg = YYY$damagecause, las = 3, yaxt="n", ylab = "Loss ($)", main = "WHEAT: Total Loss by Damage Cause \n 1989 - 2015")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))
```


```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

#--interaction plot loss vs year for all damage causes, all Palouse counties

par(mar = c(5, 5, 4, 1))
wheat <- palouse_sumloss_aggregate_wheat
i <- interaction.plot(x.factor     = wheat$year,
                 trace.factor = wheat$damagecause, 
                 trace.label = "wheat",
                 response     = wheat$loss, 
                 fun = sum,
                 las = 3,
                 type="b",
                 col=c("black","red","green"),  ### Colors for levels of trace var.
                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
                 fixed=TRUE,                    ### Order by factor order in data
                 leg.bty = "n",
                 ylab="",
                 xlab="Year",
                 main="Interaction Plot - WHEAT Loss vs. year - top damage causes", las = 2)
```


**FIGURE 5:** In the bar plot above, 1. Drought, 2. Heat, 3. Decline in Price, 4. Frost, 5. Hail, and 6. Freeze are the predominant causes for loss for WHEAT.  The interaction plot above also shows

<br></br>

###Top Damage Causes for CHERRIES, 1989-2015 for the Palouse Region

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

CHERRIES <- subset(palouse_sumloss_aggregate, commodity == "CHERRIES")

palouse_sumloss_1989_2015 <- aggregate(CHERRIES$loss, list(CHERRIES$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 1000000) 
summary_dataset2 <- X %>% filter(loss > 1000000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' billions'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for CHERRIES, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))




p

par(mar=c(11.8, 6.1, 2.1, 2.1), mgp=c(4, 1, 0), las=0)
barplot(YYY$loss, names.arg = YYY$damagecause, las = 3, yaxt="n", ylab = "Loss ($)", main = "CHERRIES: Total Loss by Damage Cause \n 1989 - 2015")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

```


```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

par(mar = c(5, 5, 4, 1))
cherries <- palouse_sumloss_aggregate_cherries
i <- interaction.plot(x.factor     = cherries$year,
                 trace.factor = cherries$damagecause, 
                 trace.label = "cherries",
                 response     = cherries$loss, 
                 fun = sum,
                 las = 3,
                 type="b",
                 col=c("black","red","green"),  ### Colors for levels of trace var.
                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
                 fixed=TRUE,                    ### Order by factor order in data
                 leg.bty = "n",
                 ylab="",
                 xlab="Year",
                 main="Interaction Plot - CHERRIES Loss vs. year - top damage causes", las = 2)
           

```


**FIGURE 6:** In the barplot above, 1. Excessive Moisture/Precipitation/Rain, 2. Freeze, 3. Frost, 4. Cold Wet Weather, are the predominant causes for loss for CHERRIES.  The interaction plot shows

<br></br>

###Top Damage Causes for DRY PEAS, 1989-2015 for the Palouse Region

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

DRYPEAS <- subset(palouse_sumloss_aggregate, commodity == "DRY PEAS")

palouse_sumloss_1989_2015 <- aggregate(DRYPEAS$loss, list(DRYPEAS$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 600000) 
summary_dataset2 <- X %>% filter(loss > 600000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' billions'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for DRY PEAS, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))



#--interaction plot loss vs year for all damage causes, all Palouse counties


p

par(mar=c(11.8, 6.1, 2.1, 2.1), mgp=c(4, 1, 0), las=0)
barplot(YYY$loss, names.arg = YYY$damagecause, las = 3, yaxt="n", ylab = "Loss ($)", main = "DRY PEAS: Total Loss by Damage Cause \n 1989 - 2015")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))
```


```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}


par(mar = c(5, 5, 4, 1))
drypeas <- palouse_sumloss_aggregate_drypeas
i <- interaction.plot(x.factor     = drypeas$year,
                 trace.factor = drypeas$damagecause, 
                 trace.label = "dry peas",
                 response     = drypeas$loss, 
                 fun = sum,
                 las = 3,
                 type="b",
                 col=c("black","red","green"),  ### Colors for levels of trace var.
                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
                 fixed=TRUE,                    ### Order by factor order in data
                 leg.bty = "n",
                 ylab="",
                 xlab="Year",
                 main="Interaction Plot - DRY PEAS Loss vs. year - top damage causes", las = 2)
           
```


**FIGURE 7:** In the bar plot above, 1. Drought, 2. Heat, 3. Hail, 4. Excessive Mositure/Precipitation/Rain, are the predominant causes for loss for DRY PEAS.  The interaction plot shows

<br></br>

##Step 6: Exploratory Data Analysis

<br></br>

###APPLES Insurance revenue loss relationships compared to damage cause, year, and county

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

#EDA for apples
#-boxplots of data by cube loss by each of the three factors
par(mar=c(8,8,4,2), mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_apples, las = 3, main = "APPLES - log10 loss by year", xlab = " Year", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_apples, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_apples, las = 3, main = "APPLES - log10 loss by damage cause", xlab = " Damage Cause", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_apples, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ county, palouse_sumloss_aggregate_apples, las = 3, main = "APPLES - log10 loss by county", xlab = " County", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_apples, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

```

**FIGURE 8:** Apples distributions for 2001-2015 for the 26 county palouse region, by damage cause, year, and county

###WHEAT Insurance revenue loss relationships compared to damage cause, year, and county

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

#EDA for wheat
#-boxplots of data by cube loss by each of the three factors
par(mar=c(10,8,4,2), mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_wheat, las = 3, main = "WHEAT - log10 loss by year", xlab = " Year", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_wheat, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_wheat, las = 3, main = "WHEAT - log10 loss by damage cause", xlab = " Damage Cause", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_wheat, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ county, palouse_sumloss_aggregate_wheat, las = 3, main = "WHEAT - log10 loss by county", xlab = " County", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_wheat, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

```

**FIGURE 9:** Wheat distributions for 2001-2015 for the 26 county palouse region, by damage cause, year, and county

###CHERRIES Insurance revenue loss relationships compared to damage cause, year, and county

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

#EDA for cherries
#-boxplots of data by cube loss by each of the three factors
par(mar=c(10,8,4,2), mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_cherries, las = 3, main = "CHERRIES - cube loss by year", xlab = " Year", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_cherries, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_cherries, las = 3, main = "CHERRIES - cube loss by damage cause", xlab = " Damage Cause", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_cherries, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ county, palouse_sumloss_aggregate_cherries, las = 3, main = "CHERRIES - cube loss by county", xlab = " County", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_cherries, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

```

**FIGURE 10:** Cherries distributions for 2001-2015 for the 26 county palouse region, by damage cause, year, and county

###DRY PEAS Insurance revenue loss relationships compared to damage cause, year, and county

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}
#EDA for dry peas
#-boxplots of data by cube loss by each of the three factors
par(mar=c(10,8,4,2), mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_drypeas, las = 3, main = "DRY PEAS - cube loss by year", xlab = " Year", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_drypeas, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_drypeas, las = 3, main = "DRY PEAS - cube loss by damage cause", xlab = " Damage Cause", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_drypeas, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ county, palouse_sumloss_aggregate_drypeas, las = 3, main = "DRY PEAS - cube loss by county", xlab = " County", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_drypeas, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

```

**FIGURE 11:** Dry Peas distributions for 2001-2015 for the 26 county palouse region, by damage cause, year, and county