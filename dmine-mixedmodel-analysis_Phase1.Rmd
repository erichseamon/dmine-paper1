---
title: 'Phase 1: Agricultural Commodity Loss Variations across the Pacific Northwest'
author: "Erich Seamon"
date: "9/25/2018"
output:
  html_document: default
  pdf_document: default
params:
  output_dir: /dmine/code/git/dmine-paper1/
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Introduction

This analysis explores the relationships of agricultural commodity loss, at a county level, from 1989-2015, for the 26 county region of the Palouse, in Washington, Idaho, and Oregon. Here we explore the entire range of commodities and damage causes, identifying the top revenue loss commodities and their most pertinent damage causes - as indicated from the USDA's agricultural commodity loss insurance archive.

We perform several steps to examine the full set of data, and to narrow down factors to a usable form, for mixed modeling analysis.
<br></br>
<br></br>
**Step 1.** Data Preparation: Loading and Transforming data.  Here we load commodity loss data, and aggregate by differing factors, so we can examine losses on an annual basis, by county, damage cause, and commodity.
<br></br>
<br></br>
**Step 2.** Study Area Overview.  We narrow down our data to the 26 county palouse region, and display a study area map for perspective.
<br></br>
<br></br>
**Step 3.** Step 3: Palouse Region Overview of Insurance Loss FREQUENCY by Year: 1989-2015
<br></br>
<br></br>
**Step 4.** Palouse Region Overview of Insurance Loss ($) by Year: 1989-2015  We summarize all insurance loss by year for 1989 - 2015 - so we can then subset our analysis to a refined time period (2001-2015).
<br></br>
<br></br>
**Step 5.** Palouse Region Overview of Insurance Loss by Commodity: 1989-2015  We summarize all commodity insurance loss for the Palouse by commodity - so we can determine the top insurance loss commodities for a filtered examination.
<br></br>
<br></br>
**Step 6.** Palouse Region Overiew of Insurance Loss by Damage Cause: 1989-2015.  Similarly to Step 3, we summarize all insurance loss by the cause of the damage for 1989 - 2015, so we can determine which damage causes are resulting the the majority of insurance loss.
<br></br>
<br></br>
**Step 7.** Palouse Region Overview of Insurance Loss by Commodity: 2001 - 2015.  Given our previous steps, we now examine Palouse commodity insurance loss for 2001 - 2015.
<br></br>
<br></br>
**Step 8.** Palouse Region Overiew of Insurance Loss by Damage Cause: 2001-2015.   In step 8, we examine Palouse commodities by damage cause for 2001-2015.
<br></br>
<br></br>
**Step 9.** Top five commodities, 2001-2015 for the Palouse Region.  In step 9, we examine the Palouse top five commodities for 2001-2015 (apples, wheat, cherries, dry peas, and barley).
<br></br>
<br></br>

##Step 1. Data Preparation: Loading and Transformation data

The first step is to load Pacific Northwest agricultural insurance commodity loss data, aggregate by county, damage cause and commodity, remove zeros, transform the loss values ($) into cube root and logrithmic outputs, and scale and center the data.  

```{r message=FALSE, warning=FALSE, echo=FALSE}

library(car)
library(RCurl)
library(lme4)
library(ez)
library(lattice)
library(ggplot2)
library(coefplot2)
library(broom)

#options(scipen=999)

#-load data
Southern_ID_sumloss <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/dmine_anova/master/PNW_summary_all.csv"), 
header = TRUE)
Southern_ID_sumloss_all_sum  <- aggregate(loss ~ year + 
                                            damagecause + county + commodity,  
                                          Southern_ID_sumloss, sum)
Southern_ID_count_all_count  <- aggregate(count ~ year + 
                                            damagecause + county + commodity,  
                                          Southern_ID_sumloss, sum)
Southern_ID_sumloss_all_sum <- 
  Southern_ID_sumloss_all_sum[Southern_ID_sumloss_all_sum$loss >= 1, ]

#-Loading all WHEAT claims for the palouse from 1989-2015
palouse_sumloss <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/dmine_anova/master/Palouse_summary_sumloss.csv"), 
header = TRUE)
palouse_counts <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/dmine_anova/master/Palouse_summary_counts.csv"), 
header = TRUE)

#use a cube transformation on loss for WHEAT claims
Math.cbrt <- function(x) {
  sign(x) * abs(x)^(1/3)
}

Southern_ID_sumloss_all_sum$cube_loss <- Math.cbrt(Southern_ID_sumloss_all_sum$loss)
Southern_ID_count_all_count$cube_counts <- Math.cbrt(Southern_ID_count_all_count$count)

#--aggregate palouse
palouse_sumloss_aggregate <- aggregate(loss ~ damagecause + year + commodity + county, 
                                       palouse_sumloss, mean)

#-calculate cube loss
palouse_sumloss_aggregate$cube_loss <- Math.cbrt(palouse_sumloss_aggregate$loss)

#-remove zeros
palouse_sumloss_aggregate <- subset(palouse_sumloss_aggregate, loss > 0)

#-use a log transform 

palouse_sumloss_aggregate$log10_loss <- log10(palouse_sumloss_aggregate$loss)
palouse_sumloss_aggregate$log_loss <- log(palouse_sumloss_aggregate$loss)

#-inverse transform
palouse_sumloss_aggregate$inverse_loss <- 1/palouse_sumloss_aggregate$loss

#sq root transformation
palouse_sumloss_aggregate$sqroot_loss <- sqrt(palouse_sumloss_aggregate$loss)

#--scale and center
palouse_sumloss_aggregate$scaled_cube_loss <- scale(palouse_sumloss_aggregate$cube_loss)
palouse_sumloss_aggregate$scaled_inverse_loss <- 
  scale(palouse_sumloss_aggregate$inverse_loss, center = TRUE, scale = TRUE)

```
<br></br>

##Step 2: Study Area Overview - 26 County Palouse Region

<div align="center">
```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(data.table)
library(maptools)
library(classInt)
library(leaflet)
library(dplyr)
library(raster)
#--irrigation analysis 2018


setwd("/dmine/data/counties/")

counties <- readShapePoly('/dmine/data/counties/threestate_palouse.shp',
                     proj4string=CRS
                     ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

#pal <- colorNumeric(palette = c("white", "orange", "darkorange", "red", "darkred"),
#                    domain = counties$NAME)
exte <- as.vector(extent(counties))

#label <- paste(sep = "<br/>", counties$NAME, round(counties$NAME, 0))
#markers <- data.frame(label)
#labs <- as.list(counties$NAME)

leaflet(data = counties, options = leafletOptions(minZoom = 6, maxZoom = 6)) %>%  addProviderTiles("Stamen.TonerLite") %>% fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(color = "blue",  weight = 1)

 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")


```
/<div>
<br></br>

##Step 3: Palouse Region Overview of Insurance Loss FREQUENCY by Year: 1989-2015

<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)
library(knitr)
library(kableExtra)
library(htmlTable)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}



palouse_sumloss_1989_2015_count <- aggregate(palouse_sumloss_aggregate$loss, list( palouse_sumloss_aggregate$damagecause, palouse_sumloss_aggregate$commodity), FUN = "length")

colnames(palouse_sumloss_1989_2015_count) <- c("damagecause", "commodity", "loss")

#-boxplots of count data for all commodities and all damage causes- 1989-2015

palouse_sumloss_1989_2015_count_commodity <- subset(palouse_sumloss_1989_2015_count, loss > 20)
palouse_sumloss_1989_2015_count_commodity <- subset(palouse_sumloss_1989_2015_count_commodity, commodity != "ADJUSTED GROSS REVENUE")
palouse_sumloss_1989_2015_count_commodity$damagecause <- factor(palouse_sumloss_1989_2015_count_commodity$damagecause)

palouse_sumloss_1989_2015_count_commodity$commodity <- factor(palouse_sumloss_1989_2015_count_commodity$commodity)


par(mar=c(8.8, 6.1, 2.1, 2.1), mgp=c(3, 1, 0), las=0)


plot(palouse_sumloss_1989_2015_count_commodity$loss ~ palouse_sumloss_1989_2015_count_commodity$commodity, ylab = "Insurance Claim Frequency", xlab = "", names.arg = palouse_sumloss_1989_2015_count_commodity$commodity, las = 3, main = "Palouse Insurance Loss Frequencies/COMMODITY 1989-2015")

title(xlab="Commodity", line=7)

plot(palouse_sumloss_1989_2015_count_commodity$loss ~ palouse_sumloss_1989_2015_count_commodity$damagecause, ylab = "Insurance Claim Frequency", xlab = "", names.arg = palouse_sumloss_1989_2015_count_commodity$damagecause, las = 3, main = "Palouse Insurance Loss Frequencies/DAMAGE CAUSE 1989-2015")

title(xlab="Damage Cause", line=7)

#model_count <- glm(formula = log(loss) ~ damagecause + commodity, family = "poisson", data = palouse_sumloss_1989_2015_count)

```
 /<div>
 
<br></br>

##Step 4: Palouse Region Overview of Insurance Loss ($) by Year: 1989-2015

<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}
#palouse_sumloss_aggregate <- subset(palouse_sumloss_aggregate, year >= 2001 & year <= 2015)

#palouse_sumloss_1989_2015 <- subset(palouse_sumloss_aggregate, commodity == "WHEAT")

palouse_sumloss_1989_2015 <- aggregate(palouse_sumloss_aggregate$loss, list(palouse_sumloss_aggregate$year), FUN = "sum")

colnames(palouse_sumloss_1989_2015) <- c("year", "loss")

#palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 

X <- palouse_sumloss_1989_2015

#X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")

XX <- X
#XX <- subset(X, loss > 1000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

#YYY1<- YYY1[seq(dim(YYY1)[1],1),]
YYY1$loss <- round(YYY1$loss, 0)
#grid.table(YYY1, theme = tt3, rows = NULL)

YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

dd2 <- cbind(YYY2[1:14, ], YYY2[15:28, ])
colnames(dd2) <- c("year", "loss", "year", "loss")
dd2[is.na(dd2)] <- ""


par(mar=c(10.8, 7.1, 2.1, 2.1), mgp=c(6, 1, 0), las=0)
#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$year, las = 3, yaxt="n", ylab = "Loss ($)", main = "Palouse region total insurance Loss by Year: 1989 - 2015", col = "lightblue", xlab = "Year") 
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")

htmlTable(dd2,
          cgroup = c("1989-2002", "2003-2015"),
          n.cgroup = c(2, 2),
          caption = "Palouse region total insurance loss by year, 1989-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")


```


##Step 5: Palouse Region Overview of Insurance Loss by Commodity: 1989-2015

<div align="center">
```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}


#palouse_sumloss_aggregate <- subset(palouse_sumloss_aggregate, year >= 1989 & year <= 201)
palouse_sumloss_1989_2015 <- aggregate(palouse_sumloss_aggregate$loss, list(palouse_sumloss_aggregate$commodity), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("commodity", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
XX <- subset(X, loss > 7000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

YYY1<- YYY1[seq(dim(YYY1)[1],1),]
#grid.table(YYY1, theme = tt3)


YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

YYY2 <- subset(YYY2, commodity != "ADJUSTED GROSS REVENUE")


#kable(YYY1, format = "html", row.names = FALSE) %>% kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE)


YYY1 <- subset(YYY1, commodity != "ADJUSTED GROSS REVENUE")
par(mar=c(10.8, 7.1, 2.1, 2.1), mgp=c(6, 1, 0), las=0)
#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$commodity, las = 3, yaxt="n", ylab = "Loss ($)", main = "Palouse region total insurance loss by commodity: \n 1989 - 2015", col = "lightblue", xlab = "Commodity") 
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

htmlTable(YYY2,
          cgroup = c("1989-2015"),
          caption = "Palouse region total insurance loss by commodity, 1989-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

```

##STEP 6: Palouse Region Overiew of Insurance Loss by Damage Cause: 1989-2015

<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

#palouse_sumloss_1989_2015 <- subset(palouse_sumloss_aggregate, commodity == "WHEAT")
palouse_sumloss_1989_2015 <- aggregate(palouse_sumloss_aggregate$loss, list(palouse_sumloss_aggregate$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("commodity", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
XX <- subset(X, loss > 10000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))


YYY1<- YYY1[seq(dim(YYY1)[1],1),]

YYY2 <- YYY1
levels(YYY2$commodity)[8] <- "Excessive Moisture"
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

#YYY2 <- subset(YYY2, commodity != "ADJUSTED GROSS REVENUE")


#grid.table(YYY1, theme = tt3)
#kable(YYY1, format = "html", row.names = FALSE) %>% kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE)

par(mar=c(11.8, 6.1, 2.1, 2.1), mgp=c(4, 1, 0), las=0)
levels(YYY1$commodity)[8] <- "Excessive Moisture"
barplot(YYY1$loss, names.arg = YYY1$commodity, las = 3, yaxt="n", ylab = "Loss ($)", main = "Total Insurance Loss by Damage Cause: \n 1989 - 2015 for the Palouse", col = "lightblue")
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

mtext(text = "Damage Cause",
      side = 1,#side 1 = bottom
      line = 9)

htmlTable(YYY2,
          cgroup = c("1989-2015"),
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

```


##Step 7: Palouse Region Overview of Insurance Loss by Commodity: 2001 - 2015

<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}


palouse_sumloss_aggregate <- subset(palouse_sumloss_aggregate, year >= 2001 & year <= 2015)
palouse_sumloss_1989_2015 <- aggregate(palouse_sumloss_aggregate$loss, list(palouse_sumloss_aggregate$commodity), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("commodity", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
XX <- subset(X, loss > 7000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

YYY1<- YYY1[seq(dim(YYY1)[1],1),]

YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

YYY2 <- subset(YYY2, commodity != "ADJUSTED GROSS REVENUE")

#grid.table(YYY1, theme = tt3)
#kable(YYY1, format = "html", row.names = FALSE) %>% kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE)


YYY1 <- subset(YYY1, commodity != "ADJUSTED GROSS REVENUE")
par(mar=c(10.8, 7.1, 2.1, 2.1), mgp=c(6, 1, 0), las=0)
#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$commodity, las = 3, yaxt="n", ylab = "Loss ($)", main = "Palouse region total insurance loss by commodity: \n 2001 - 2015", col = "lightblue", xlab = "Commodity") 
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

htmlTable(YYY2,
          cgroup = c("2001-2015"),
           caption = "Palouse region total insurance loss by commodity, 2001-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

```


##STEP 8: Palouse Region Overiew of Insurance Loss by Damage Cause: 2001-2015

<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

palouse_sumloss_1989_2015 <- aggregate(palouse_sumloss_aggregate$loss, list(palouse_sumloss_aggregate$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("commodity", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
XX <- subset(X, loss > 10000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))


YYY1<- YYY1[seq(dim(YYY1)[1],1),]

YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

#YYY2 <- subset(YYY2, commodity != "ADJUSTED GROSS REVENUE")

levels(YYY2$commodity)[8] <- "Excessive Moisture"

#grid.table(YYY1, theme = tt3)
#kable(YYY1, format = "html", row.names = FALSE) %>% kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE)
levels(YYY1$commodity)[8] <- "Excessive Moisture"
par(mar=c(11.9, 6.1, 2.1, 2.1), mgp=c(4, 1, 0), las=0)
barplot(YYY1$loss, names.arg = YYY1$commodity, las = 3, yaxt="n", ylab = "Loss ($)", main = "Total Insurance Loss by Damage Cause: \n 1989 - 2015 for the Palouse", col = "lightblue")
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

mtext(text = "Damage Cause",
      side = 1,#side 1 = bottom
      line = 10)

htmlTable(YYY2,
          cgroup = c("2001-2015"),
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

```

<br></br>

##STEP 9: Damage Cause Overview for EACH of the four top commodities

<br></br>

### Top Damage Causes for APPLES, 2001-2015 for the Palouse Region

<br></br>

<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

#--reduce years to 2001-2015
xxyear <- subset(palouse_sumloss_aggregate, year >= 2001)

#missing data review of data from 2001-2015 for all commodities and all damage causes
#ezDesign(xxyear, year, damagecause)
#ezDesign(xxyear, county, damagecause)
#ezDesign(xxyear, county, commodity)

#Now lets subset by the four main commodities of interest.
#--subset to four commodities - Barley, Wheat, Apples, and Dry Peas
xx <- subset(xxyear, commodity == "BARLEY" | commodity == "WHEAT" | 
               commodity == "APPLES" | commodity == "DRY PEAS" | commodity == "CHERRIES" | commodity == "BARLEY")

#--subset to a select set of damage causes - Drought, Heat, Hail, Frost, Freeze, Excessive Moisture, Cold Winter, Cold Weather, and Decline in Price
xxx <- subset(xx, damagecause == "Drought" | damagecause == "Heat" | 
                damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze" | damagecause == "Excessive Moisture/Precip/Rain" | damagecause == "Cold Winter" | 
                damagecause == "Cold Wet Weather" | damagecause == "Decline in Price")


#examine missing data after narrowing commodities and damage causes to the most relevant
#ezDesign(xxx, year, damagecause)
#ezDesign(xxx, county, year)
#ezDesign(xxx, county, damagecause)
#ezDesign(xxx, year, commodity)
#ezDesign(xxx, county, commodity)

#palouse_sumloss_aggregate <- xxx

#now lets divide the data into four different model files that are commodity specific.
xxx_wheat <- subset(xxx, commodity == "WHEAT")
xxx_apples <- subset(xxx, commodity == "APPLES")
xxx_cherries <- subset(xxx, commodity == "CHERRIES")
xxx_drypeas <- subset(xxx, commodity == "DRY PEAS")
xxx_barley <- subset(xxx, commodity == "BARLEY")

palouse_sumloss_aggregate_apples <- xxx_apples
palouse_sumloss_aggregate_cherries <- xxx_cherries
palouse_sumloss_aggregate_drypeas <- xxx_drypeas
palouse_sumloss_aggregate_wheat <- xxx_wheat
palouse_sumloss_aggregate_barley <- xxx_barley

#-remove counties for each commodity file that have considerable missing data.  
#the reasoning is that those counties that have very little of the commodity in question
#may be inappropriate to fill in data as zero.  While there are sporadic commodity loss
#for these counties, there is a high liklihood that this commodity may NOT be grown
#for the missing years, vs just no commodity loss claims.  So we remove these select
#counties given the EzDesign data review of each commodity file

palouse_sumloss_aggregate_apples <- subset(palouse_sumloss_aggregate_apples, 
                                           county != "Columbia" & county != "Wasco")
palouse_sumloss_aggregate_apples$county <- 
  factor(palouse_sumloss_aggregate_apples$county)

palouse_sumloss_aggregate_apples <- 
  subset(palouse_sumloss_aggregate_apples, damagecause != "Drought")
palouse_sumloss_aggregate_apples$damagecause <- 
  factor(palouse_sumloss_aggregate_apples$damagecause)


palouse_sumloss_aggregate_wheat <- 
  subset(palouse_sumloss_aggregate_wheat, county != "Kootenai")
palouse_sumloss_aggregate_wheat$county <- 
  factor(palouse_sumloss_aggregate_wheat$county)

palouse_sumloss_aggregate_cherries <- 
  subset(palouse_sumloss_aggregate_cherries, county != "Adams" & county != "Union")
palouse_sumloss_aggregate_cherries$county <- 
  factor(palouse_sumloss_aggregate_cherries$county)

palouse_sumloss_aggregate_drypeas <- 
  subset(palouse_sumloss_aggregate_drypeas, county != "Douglas" 
         & county != "Gilliam" & county != "Adams")
palouse_sumloss_aggregate_drypeas$county <- 
  factor(palouse_sumloss_aggregate_drypeas$county)

palouse_sumloss_aggregate_barley <- 
  subset(palouse_sumloss_aggregate_barley, county != "Douglas" & county != "Garfield"
         & county != "Gilliam" & county != "Adams" & county != "Kootenai" & county != "Benton")
palouse_sumloss_aggregate_barley$county <- 
  factor(palouse_sumloss_aggregate_barley$county)

palouse_sumloss_aggregate_barley <- 
  subset(palouse_sumloss_aggregate_barley, damagecause != "Cold Winter")
palouse_sumloss_aggregate_barley$damagecause <- 
  factor(palouse_sumloss_aggregate_barley$damagecause)

#re-factor 

palouse_sumloss_aggregate_apples$damagecause <- factor(palouse_sumloss_aggregate_apples$damagecause)
palouse_sumloss_aggregate_wheat$damagecause <- factor(palouse_sumloss_aggregate_wheat$damagecause)
palouse_sumloss_aggregate_cherries$damagecause <- factor(palouse_sumloss_aggregate_cherries$damagecause)
palouse_sumloss_aggregate_drypeas$damagecause <- factor(palouse_sumloss_aggregate_drypeas$damagecause)
palouse_sumloss_aggregate_barley$damagecause <- factor(palouse_sumloss_aggregate_barley$damagecause)

```


<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

APPLES <- subset(palouse_sumloss_aggregate, commodity == "APPLES")

palouse_sumloss_1989_2015 <- aggregate(APPLES$loss, list(APPLES$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 1500000) 
summary_dataset2 <- X %>% filter(loss > 1500000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' million'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for APPLES, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

           
#p

YYY2 <- YYY1
YYY2$loss <- round(YYY2$loss, digits = 0)
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)




par(mar=c(11.8, 6.1, 2.1, 2.1), mgp=c(4, 1, 0), las=0)
barplot(YYY1$loss, names.arg = YYY1$damagecause, las = 3, yaxt="n", ylab = "Loss ($)", main = "APPLES: Total Loss by Damage Cause \n 2001 - 2015", col = "lightblue")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

mtext(text = "Damage Cause",
      side = 1,#side 1 = bottom
      line = 9.5)

htmlTable(YYY2,
          cgroup = c("2001-2015"),
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

```


<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

#--interaction plot loss vs year for all damage causes, all Palouse counties

levels(APPLES$damagecause)[8] <- "Excessive Moisture"
APPLES$damagecause <- factor(APPLES$damagecause)

APPLES_damage <- subset(APPLES, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze" | damagecause == "Cold Wet Weather" | damagecause == "Wind/Excess Wind" | damagecause == "Heat")

APPLES_damage$damagecause <- factor(APPLES_damage$damagecause)
#aggregate(WHEAT_damage$loss, list(WHEAT_damage$damagecause), FUN = "sum")

library(scales)

ggplot(APPLES_damage, aes(fill=damagecause, y=loss, x=year)) + 
    geom_bar( stat="identity") + theme_bw() + ggtitle("APPLES Loss vs. year - top damage causes") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + theme(plot.title = element_text(hjust = 0.5))  +  scale_x_discrete(limits=c(2001:2015)) + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))



par(mar = c(5, 5, 4, 1))
apples <- palouse_sumloss_aggregate_apples
#i <- interaction.plot(x.factor     = apples$year,
#                 trace.factor = apples$damagecause, 
#                 trace.label = "apples",
#                 response     = apples$loss, 
#                 fun = sum,
#                 las = 3,
#                 type="p",
#                 col=c("black","red","green"),  ### Colors for levels of trace var.
#                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
#                 fixed=TRUE,                    ### Order by factor order in data
#                 leg.bty = "n",
#                 ylab="",
#                 xlab="Year",
#                 main="Interaction Plot - APPLES Loss vs. year - top damage causes", las = 2)

#EDA for apples
#-boxplots of data by cube loss by each of the three factors
par(mar=c(8,8,4,2), mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_apples, las = 3, main = "APPLES - log10 loss by year", xlab = " Year", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_apples, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_apples, las = 3, main = "APPLES - log10 loss by damage cause", xlab = " Damage Cause", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_apples, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ county, palouse_sumloss_aggregate_apples, las = 3, main = "APPLES - log10 loss by county", xlab = " County", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_apples, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')


```


### Top Damage Causes for BARLEY, 2001-2015 for the Palouse Region

<br></br>
<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

BARLEY <- subset(palouse_sumloss_aggregate, commodity == "BARLEY")

palouse_sumloss_1989_2015 <- aggregate(BARLEY$loss, list(BARLEY$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 390000) 
summary_dataset2 <- X %>% filter(loss > 390000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' million'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for BARLEY, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

           
#p

YYY2 <- YYY1
YYY2$loss <- round(YYY2$loss, digits = 0)
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)




par(mar=c(11.8, 6.1, 2.1, 2.1), mgp=c(4, 1, 0), las=0)
barplot(YYY1$loss, names.arg = YYY1$damagecause, las = 3, yaxt="n", ylab = "Loss ($)", main = "BARLEY: Total Loss by Damage Cause \n 2001 - 2015", col = "lightblue")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

mtext(text = "Damage Cause",
      side = 1,#side 1 = bottom
      line = 9.5)

htmlTable(YYY2,
          cgroup = c("2001-2015"),
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

```


<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

#--interaction plot loss vs year for all damage causes, all Palouse counties

levels(BARLEY$damagecause)[8] <- "Excessive Moisture"
BARLEY$damagecause <- factor(BARLEY$damagecause)

BARLEY_damage <- subset(BARLEY, damagecause == "Drought" | damagecause == "Heat" | damagecause == "Excessive Moisture" | damagecause == "Hail" | damagecause == "Frost" | damagecause == "Decline in Price" | damagecause == "Cold Wet Weather")

BARLEY_damage$damagecause <- factor(BARLEY_damage$damagecause)
#aggregate(WHEAT_damage$loss, list(WHEAT_damage$damagecause), FUN = "sum")

library(scales)

ggplot(BARLEY_damage, aes(fill=damagecause, y=loss, x=year)) + 
    geom_bar( stat="identity") + theme_bw() + ggtitle("BARLEY Loss vs. year - top damage causes") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + theme(plot.title = element_text(hjust = 0.5))  +  scale_x_discrete(limits=c(2001:2015)) + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))



par(mar = c(5, 5, 4, 1))
barley <- palouse_sumloss_aggregate_barley
#i <- interaction.plot(x.factor     = barley$year,
#                 trace.factor = barley$damagecause, 
#                 trace.label = "barley",
#                 response     = barley$loss, 
#                 fun = sum,
#                 las = 3,
#                 type="p",
#                 col=c("black","red","green"),  ### Colors for levels of trace var.
#                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
#                 fixed=TRUE,                    ### Order by factor order in data
#                 leg.bty = "n",
#                 ylab="",
#                 xlab="Year",
#                 main="Interaction Plot - barley Loss vs. year - top damage causes", las = 2)

#EDA for barley
#-boxplots of data by cube loss by each of the three factors
par(mar=c(8,8,4,2), mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_barley, las = 3, main = "BARLEY - log10 loss by year", xlab = " Year", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_barley, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_barley, las = 3, main = "BARLEY - log10 loss by damage cause", xlab = " Damage Cause", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_barley, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ county, palouse_sumloss_aggregate_barley, las = 3, main = "BARLEY - log10 loss by county", xlab = " County", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_barley, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')


```
/<div>


<br></br>

### Top Damage Causes for WHEAT, 2001-2015 for the Palouse Region

<div align="center">
```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

WHEAT <- subset(palouse_sumloss_aggregate, commodity == "WHEAT")

palouse_sumloss_1989_2015 <- aggregate(WHEAT$loss, list(WHEAT$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 2000000) 
summary_dataset2 <- X %>% filter(loss > 2000000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' billions'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for WHEAT, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

  
#p         

YYY2 <- YYY1
levels(YYY2$damagecause)[7] <- "Excessive Moisture"

YYY2$loss <- round(YYY2$loss, digits = 0)
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

par(mar=c(11.8, 6.1, 2.1, 2.1), mgp=c(4, 1, 0), las=0)
levels(YYY1$damagecause)[8] <- "Excessive Moisture"

barplot(YYY1$loss, names.arg = YYY1$damagecause, las = 3, yaxt="n", ylab = "Loss ($)", main = "WHEAT: Total Loss by Damage Cause \n 2001 - 2015", col = "lightblue")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

mtext(text = "Damage Cause",
      side = 1,#side 1 = bottom
      line = 10)

htmlTable(YYY2,
          cgroup = c("2001-2015"),
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")
```


<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

#--interaction plot loss vs year for all damage causes, all Palouse counties
levels(WHEAT$damagecause)[8] <- "Excessive Moisture"
WHEAT$damagecause <- factor(WHEAT$damagecause)

WHEAT_damage <- subset(WHEAT, damagecause == "Drought" | damagecause == "Heat" | damagecause == "Decline in Price" | damagecause == "Frost" | damagecause == "Hail" | damagecause == "Excessive Moisture" | damagecause == "Freeze" | damagecause == "Cold Winter" | damagecause == "Cold Wet Weather")
WHEAT_damage$damagecause <- factor(WHEAT_damage$damagecause)

#aggregate(WHEAT_damage$loss, list(WHEAT_damage$damagecause), FUN = "sum")


ggplot(WHEAT_damage, aes(fill=damagecause, y=loss, x=year)) + 
    geom_bar( stat="identity") + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 0)) + ggtitle("WHEAT Loss vs. year - top damage causes") + theme(plot.title = element_text(hjust = 0.5)) +  scale_x_discrete(limits=c(2001:2015)) + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))

par(mar = c(5, 5, 4, 1))
wheat <- palouse_sumloss_aggregate_wheat
#i <- interaction.plot(x.factor     = wheat$year,
#                 trace.factor = wheat$damagecause, 
#                 trace.label = "wheat",
#                 response     = wheat$loss, 
#                 fun = sum,
#                 las = 3,
#                 type="b",
#                 col=c("black","red","green"),  ### Colors for levels of trace var.
#                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
#                 fixed=TRUE,                    ### Order by factor order in data
#                 leg.bty = "n",
#                 ylab="",
#                 xlab="Year",
#                 main="Interaction Plot - WHEAT Loss vs. year - top damage causes", las = 2)

#EDA for wheat
#-boxplots of data by cube loss by each of the three factors
par(mar=c(10,8,4,2), mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_wheat, las = 3, main = "WHEAT - log10 loss by year", xlab = " Year", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_wheat, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_wheat, las = 3, main = "WHEAT - log10 loss by damage cause", xlab = " Damage Cause", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_wheat, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ county, palouse_sumloss_aggregate_wheat, las = 3, main = "WHEAT - log10 loss by county", xlab = " County", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_wheat, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

```
/<div>

<br></br>

###Top Damage Causes for CHERRIES, 2001-2015 for the Palouse Region

<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

CHERRIES <- subset(palouse_sumloss_aggregate, commodity == "CHERRIES")
palouse_sumloss_1989_2015 <- aggregate(CHERRIES$loss, list(CHERRIES$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 1000000) 
summary_dataset2 <- X %>% filter(loss > 1000000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]


p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' billions'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for CHERRIES, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))




#p

YYY2 <- YYY1
levels(YYY2$damagecause)[8] <- "Excessive Moisture"

YYY2$loss <- round(YYY2$loss, digits = 0)
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)


par(mar=c(11.8, 6.1, 2.1, 2.1), mgp=c(4, 1, 0), las=0)
levels(YYY1$damagecause)[8] <- "Excessive Moisture"

barplot(YYY1$loss, names.arg = YYY1$damagecause, las = 3, yaxt="n", ylab = "Loss ($)", main = "CHERRIES: Total Loss by Damage Cause \n 2001 - 2015", col = "lightblue")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

mtext(text = "Damage Cause",
      side = 1,#side 1 = bottom
      line = 10)

htmlTable(YYY2,
          cgroup = c("2001-2015"),
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

```


<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}


CHERRIES <- subset(palouse_sumloss_aggregate, commodity == "CHERRIES")

levels(CHERRIES$damagecause)[8] <- "Excessive Moisture"
CHERRIES$damagecause <- factor(CHERRIES$damagecause)



CHERRIES_damage <- subset(CHERRIES, damagecause =="Excessive Moisture" | damagecause == "Freeze" | damagecause == "Frost" | damagecause == "Cold Wet Weather" | damagecause == "Hail" | damagecause == "Decline in Price" | damagecause == "Heat" | damagecause == "Wind/Excess Wind")

CHERRIES_damage$damagecause <- factor(CHERRIES_damage$damagecause) 





ggplot(CHERRIES_damage, aes(fill=damagecause, y=loss, x=year)) + 
    geom_bar( stat="identity") + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + ggtitle("CHERRIES Loss vs. year - top damage causes") + theme(plot.title = element_text(hjust = 0.5))  +  scale_x_discrete(limits=c(2001:2015))  + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))

par(mar = c(5, 5, 4, 1))
cherries <- palouse_sumloss_aggregate_cherries
#i <- interaction.plot(x.factor     = cherries$year,
#                 trace.factor = cherries$damagecause, 
#                 trace.label = "cherries",
#                 response     = cherries$loss, 
#                 fun = sum,
#                 las = 3,
#                 type="b",
#                 col=c("black","red","green"),  ### Colors for levels of trace var.
#                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
#                 fixed=TRUE,                    ### Order by factor order in data
#                 leg.bty = "n",
#                 ylab="",
#                 xlab="Year",
#                 main="Interaction Plot - CHERRIES Loss vs. year - top damage causes", las = 2)
           
#EDA for cherries
#-boxplots of data by cube loss by each of the three factors
par(mar=c(10,8,4,2), mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_cherries, las = 3, main = "CHERRIES - cube loss by year", xlab = " Year", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_cherries, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_cherries, las = 3, main = "CHERRIES - cube loss by damage cause", xlab = " Damage Cause", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_cherries, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ county, palouse_sumloss_aggregate_cherries, las = 3, main = "CHERRIES - cube loss by county", xlab = " County", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_cherries, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

```
/<div>

<br></br>

###Top Damage Causes for DRY PEAS, 2001-2015 for the Palouse Region

<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

DRYPEAS <- subset(palouse_sumloss_aggregate, commodity == "DRY PEAS")

palouse_sumloss_1989_2015 <- aggregate(DRYPEAS$loss, list(DRYPEAS$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 600000) 
summary_dataset2 <- X %>% filter(loss > 600000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' billions'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for DRY PEAS, Palouse Region: 2001-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))



#--interaction plot loss vs year for all damage causes, all Palouse counties


#p

YYY2 <- YYY1
levels(YYY2$damagecause)[8] <- "Excessive Moisture"
YYY2$loss <- round(YYY2$loss, digits = 0)
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

par(mar=c(11.8, 6.1, 2.1, 2.1), mgp=c(4, 1, 0), las=0)
levels(YYY1$damagecause)[8] <- "Excessive Moisture"
barplot(YYY1$loss, names.arg = YYY1$damagecause, las = 3, yaxt="n", ylab = "Loss ($)", main = "DRY PEAS: Total Loss by Damage Cause \n 2001 - 2015", col = "lightblue")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))

mtext(text = "Damage Cause",
      side = 1,#side 1 = bottom
      line = 10)

htmlTable(YYY2,
          cgroup = c("2001-2015"),
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")
```


<div align="center">

```{r message=FALSE, warning=FALSE, error=TRUE, echo=FALSE}

levels(DRYPEAS$damagecause)[8] <- "Excessive Moisture"
DRYPEAS$damagecause <- factor(DRYPEAS$damagecause)

DRYPEAS_damage <- subset(DRYPEAS, damagecause == "Drought" | damagecause == "Heat" | damagecause == "Excessive Moisture" | damagecause == "Hail" | damagecause == "Cold Wet Weather" | damagecause == "Decline in Price" | damagecause == "Frost" | damagecause == "Wind/Excess Wind")
DRYPEAS_damage$damagecause <- factor(DRYPEAS_damage$damagecause)


ggplot(DRYPEAS_damage, aes(fill=damagecause, y=loss, x=year)) + 
    geom_bar( stat="identity") + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + ggtitle("DRY PEAS Loss vs. year - top damage causes") + theme(plot.title = element_text(hjust = 0.5)) +  scale_x_discrete(limits=c(2001:2015)) + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))


par(mar = c(5, 5, 4, 1))
drypeas <- palouse_sumloss_aggregate_drypeas
#i <- interaction.plot(x.factor     = drypeas$year,
#                 trace.factor = drypeas$damagecause, 
#                 trace.label = "dry peas",
#                 response     = drypeas$loss, 
#                 fun = sum,
#                 las = 3,
#                 type="b",
#                 col=c("black","red","green"),  ### Colors for levels of trace var.
#                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
#                 fixed=TRUE,                    ### Order by factor order in data
#                 leg.bty = "n",
#                 ylab="",
#                 xlab="Year",
#                 main="Interaction Plot - DRY PEAS Loss vs. year - top damage causes", las = 2)

#EDA for dry peas
#-boxplots of data by cube loss by each of the three factors
par(mar=c(10,8,4,2), mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_drypeas, las = 3, main = "DRY PEAS - cube loss by year", xlab = " Year", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_drypeas, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_drypeas, las = 3, main = "DRY PEAS - cube loss by damage cause", xlab = " Damage Cause", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_drypeas, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
boxplot(log10_loss ~ county, palouse_sumloss_aggregate_drypeas, las = 3, main = "DRY PEAS - cube loss by county", xlab = " County", ylab = "log10 commodity loss ($)")
stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_drypeas, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
           
```
/<div>
